#!/usr/bin/env ruby

## Created: 2011-06-09
## Authors: Y.Kimura, Yoshinar Nomura

## Use Bundler and rbenv
if File.symlink?(__FILE__) and ENV["RBENV_VERSION"]
  ENV["RBENV_VERSION"] = nil
  shims_path = File.expand_path("shims", ENV["RBENV_ROOT"])
  ENV["PATH"] = shims_path + ":" + ENV["PATH"]
  exec(File.readlink(__FILE__), *ARGV)
end

ENV["BUNDLE_GEMFILE"] = File.expand_path("../../Gemfile", __FILE__)

Encoding.default_external="UTF-8"

require 'rubygems'
require 'bundler/setup'
require 'nomnichi_bot'

$NOMNICHI_BOT_DEBUG = false
$NOMNICHI_BOT_TEST  = false
$NOMNICHI_BOT_METHOD = :tweet

# parse options
while ARGV[0] =~ /^--(.*)/
  case $1
  when "debug"
    $NOMNICHI_BOT_DEBUG = true
  when "test"
    $NOMNICHI_BOT_TEST = true
  when "slack"
    $NOMNICHI_BOT_METHOD = :slack
  end
  ARGV.shift
end

sender = if $NOMNICHI_BOT_TEST
           NomnichiBot::TweetTest.new
         elsif $NOMNICHI_BOT_METHOD == :slack
           NomnichiBot::SlackSender.new
         else
           NomnichiBot::TweetSender.new
         end

reporter = NomnichiBot::Reporter

sender.send_message(ARGV[0]) if ARGV[0]

subjects = [:nomnichi, :tvshow, :weather, :security_advisory, :calendar]

subjects.each do |subject|
  print "* #{subject}:\n" if $NOMNICHI_BOT_TEST || $NOMNICHI_BOT_DEBUG
  if msg = reporter.report(subject)
    sender.send_message(msg)
  end
end

exit 0
